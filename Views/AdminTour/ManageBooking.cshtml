@model IEnumerable<TourDuLich.Models.Booking>

@{
    ViewData["Title"] = "Qu·∫£n L√Ω ƒê∆°n ƒê·∫∑t Tour";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
}

@Html.AntiForgeryToken()

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-clipboard-check me-2"></i>Qu·∫£n L√Ω ƒê∆°n ƒê·∫∑t Tour</h2>
                <div class="badge bg-info fs-6">
                    <i class="bi bi-list-ul me-1"></i>
                    T·ªïng: @Model.Count() ƒë∆°n h√†ng
                </div>
            </div>

            @if (ViewBag.CurrentUserType != 2)
            {
                <div class="alert alert-danger">
                    <i class="bi bi-shield-exclamation me-2"></i>
                    <strong>Kh√¥ng c√≥ quy·ªÅn truy c·∫≠p!</strong> Ch·ªâ Admin m·ªõi c√≥ th·ªÉ qu·∫£n l√Ω ƒë∆°n ƒë·∫∑t tour.
                </div>
            }
            else if (!Model.Any())
            {
                <div class="alert alert-info text-center">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="mt-3">Ch∆∞a c√≥ ƒë∆°n ƒë·∫∑t tour n√†o</h4>
                    <p class="text-muted">C√°c ƒë∆°n ƒë·∫∑t tour s·∫Ω hi·ªÉn th·ªã t·∫°i ƒë√¢y khi kh√°ch h√†ng ƒë·∫∑t tour.</p>
                </div>
            }
            else
            {
                <!-- Danh s√°ch ƒë∆°n h√†ng -->
                <div class="row">
                    @foreach (var booking in Model)
                    {
                        <div class="col-lg-6 col-xl-4 mb-4">
                            <div class="card shadow-sm h-100">
                                <!-- Header v·ªõi status -->
                                <div class="card-header d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <i class="bi bi-receipt me-2"></i>
                                        ƒê∆°n h√†ng #@booking.BookingId
                                    </h6>
                                    <span class="badge @GetStatusBadgeClass(booking.Status) fs-6">
                                        @GetStatusText(booking.Status)
                                    </span>
                                </div>

                                <div class="card-body">
                                    <!-- Th√¥ng tin tour -->
                                    <div class="mb-3">
                                        <h6 class="text-primary mb-2">
                                            <i class="bi bi-geo-alt me-1"></i>
                                            @booking.Tour?.TourName
                                        </h6>
                                        
                                        <div class="row tour-details text-muted small">
                                            <div class="col-6">
                                                <i class="bi bi-calendar-event me-1"></i>
                                                <strong>Kh·ªüi h√†nh:</strong><br>
                                                @booking.DepartureDate.ToString("dd/MM/yyyy")
                                            </div>
                                            <div class="col-6">
                                                <i class="bi bi-people me-1"></i>
                                                <strong>S·ªë kh√°ch:</strong><br>
                                                @(booking.AdultCount + booking.ChildCount + booking.InfantCount + booking.BabyCount) ng∆∞·ªùi
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Th√¥ng tin gi√° v√† thanh to√°n -->
                                    <div class="row mb-3">
                                        <div class="col-6">
                                            <div class="payment-info">
                                                <i class="bi bi-cash-coin me-1 text-success"></i>
                                                <strong>T·ªïng ti·ªÅn:</strong><br>
                                                <span class="text-danger fw-bold">@booking.TotalPrice.ToString("N0") ƒë</span>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="payment-info">
                                                <i class="bi bi-credit-card me-1"></i>
                                                <strong>Thanh to√°n:</strong><br>
                                                <span class="badge @GetPaymentStatusBadgeClass(booking.PaymentStatus)">
                                                    @GetPaymentStatusText(booking.PaymentStatus)
                                                </span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Th√¥ng tin kh√°ch h√†ng -->
                                    <div class="mb-3 small text-muted">
                                        <i class="bi bi-person me-1"></i>
                                        <strong>Kh√°ch h√†ng:</strong> @booking.CustomerName<br>
                                        <i class="bi bi-envelope me-1"></i>
                                        @booking.CustomerEmail<br>
                                        <i class="bi bi-telephone me-1"></i>
                                        @booking.CustomerPhone
                                    </div>

                                    <!-- Ng√†y ƒë·∫∑t -->
                                    <div class="booking-date text-muted small">
                                        <i class="bi bi-clock me-1"></i>
                                        <strong>ƒê·∫∑t ng√†y:</strong> @booking.BookingDate.ToString("dd/MM/yyyy HH:mm")
                                    </div>
                                </div>

                                <!-- Footer v·ªõi c√°c n√∫t action -->
                                <div class="card-footer bg-light">
                                    <div class="d-flex flex-wrap gap-2">
                                        <!-- N√∫t Xem chi ti·∫øt -->
                                        <button class="btn btn-outline-info btn-sm flex-fill" 
                                                onclick="viewBookingDetails(@booking.BookingId)">
                                            <i class="bi bi-eye me-1"></i>Chi ti·∫øt
                                        </button>

                                        @if (booking.Status == "Pending")
                                        {
                                            <!-- N√∫t X√°c nh·∫≠n -->
                                            <button class="btn btn-success btn-sm flex-fill" 
                                                    onclick="confirmBooking(@booking.BookingId)">
                                                <i class="bi bi-check-circle me-1"></i>X√°c nh·∫≠n
                                            </button>
                                        }

                                        @if (booking.Status != "Cancelled")
                                        {
                                            <!-- N√∫t H·ªßy ƒë∆°n -->
                                            <button class="btn btn-outline-danger btn-sm flex-fill" 
                                                    onclick="cancelBooking(@booking.BookingId)">
                                                <i class="bi bi-x-circle me-1"></i>H·ªßy
                                            </button>
                                        }

                                        <!-- N√∫t Li√™n h·ªá -->
                                        <button class="btn btn-outline-primary btn-sm flex-fill" 
                                                onclick="contactCustomer('@booking.CustomerPhone')">
                                            <i class="bi bi-telephone me-1"></i>Li√™n h·ªá
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal Chi ti·∫øt ƒë∆°n h√†ng -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-info-circle me-2"></i>Chi ti·∫øt ƒë∆°n h√†ng
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="bookingDetailsContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning text-dark",
            "Confirmed" => "bg-success",
            "Cancelled" => "bg-danger",
            "Completed" => "bg-primary",
            _ => "bg-secondary"
        };
    }

    string GetStatusText(string status)
    {
        return status switch
        {
            "Pending" => "Ch·ªù x√°c nh·∫≠n",
            "Confirmed" => "Tour ƒê√£ X√°c Nh·∫≠n",
            "Cancelled" => "Tour ƒë√£ b·ªã h·ªßy",
            "Completed" => "Ho√†n th√†nh",
            _ => "Kh√¥ng x√°c ƒë·ªãnh"
        };
    }

    string GetPaymentStatusBadgeClass(string paymentStatus)
    {
        return paymentStatus switch
        {
            "Pending" => "bg-warning text-dark",
            "Paid" => "bg-success",
            "Failed" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetPaymentStatusText(string paymentStatus)
    {
        return paymentStatus switch
        {
            "Pending" => "Ch·ªù thanh to√°n",
            "Paid" => "ƒê√£ thanh to√°n",
            "Failed" => "Th·∫•t b·∫°i",
            _ => "Kh√¥ng x√°c ƒë·ªãnh"
        };
    }
}

<script>
$(document).ready(function() {
    // ƒê·∫£m b·∫£o jQuery ƒë√£ load
    console.log('jQuery loaded:', typeof $ !== 'undefined');
});

// Xem chi ti·∫øt ƒë∆°n h√†ng
function viewBookingDetails(bookingId) {
    $('#bookingDetailsContent').html(`
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">ƒêang t·∫£i...</span>
            </div>
        </div>
    `);

    $('#bookingDetailsModal').modal('show');

    $.get('/AdminTour/GetBookingDetails', { bookingId: bookingId })
        .done(function(response) {
            if (response.success) {
                const data = response.data;
                $('#bookingDetailsContent').html(`
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-person-circle me-2"></i>Th√¥ng tin kh√°ch h√†ng</h6>
                            <table class="table table-sm">
                                <tr><td><strong>H·ªç t√™n:</strong></td><td>${data.customerName || 'N/A'}</td></tr>
                                <tr><td><strong>Email:</strong></td><td>${data.customerEmail || 'N/A'}</td></tr>
                                <tr><td><strong>ƒêi·ªán tho·∫°i:</strong></td><td>${data.customerPhone || 'N/A'}</td></tr>
                                <tr><td><strong>ƒê·ªãa ch·ªâ:</strong></td><td>${data.customerAddress || 'N/A'}</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-geo-alt me-2"></i>Th√¥ng tin tour</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Tour:</strong></td><td>${data.tourName || 'N/A'}</td></tr>
                                <tr><td><strong>Kh·ªüi h√†nh:</strong></td><td>${data.departureDate}</td></tr>
                                <tr><td><strong>T·ªïng ti·ªÅn:</strong></td><td class="text-danger fw-bold">${data.totalPrice} ƒë</td></tr>
                                <tr><td><strong>Thanh to√°n:</strong></td><td>${data.paymentMethod || 'N/A'}</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <h6><i class="bi bi-people me-2"></i>S·ªë l∆∞·ª£ng kh√°ch</h6>
                            <table class="table table-sm">
                                <tr><td>Ng∆∞·ªùi l·ªõn:</td><td>${data.adultCount}</td></tr>
                                <tr><td>Tr·∫ª em:</td><td>${data.childCount}</td></tr>
                                <tr><td>Em b√©:</td><td>${data.infantCount}</td></tr>
                                <tr><td>Tr·∫ª s∆° sinh:</td><td>${data.babyCount}</td></tr>
                                ${data.singleRoomCount > 0 ? `<tr><td>Ph√≤ng ƒë∆°n:</td><td>${data.singleRoomCount}</td></tr>` : ''}
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-chat-text me-2"></i>Ghi ch√∫</h6>
                            <div class="border p-2 rounded bg-light">
                                ${data.notes || '<em class="text-muted">Kh√¥ng c√≥ ghi ch√∫</em>'}
                            </div>
                        </div>
                    </div>
                `);
            } else {
                $('#bookingDetailsContent').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${response.message}
                    </div>
                `);
            }
        })
        .fail(function() {
            $('#bookingDetailsContent').html(`
                <div class="alert alert-danger">
                    <i class="bi bi-wifi-off me-2"></i>
                    Kh√¥ng th·ªÉ t·∫£i th√¥ng tin chi ti·∫øt. Vui l√≤ng th·ª≠ l·∫°i!
                </div>
            `);
        });
}

// X√°c nh·∫≠n ƒë∆°n h√†ng
function confirmBooking(bookingId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√°c nh·∫≠n ƒë∆°n h√†ng n√†y?')) {
        $.post('/AdminTour/ConfirmBooking', {
            bookingId: bookingId,
            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
        })
            .done(function(response) {
                if (response.success) {
                    alert('‚úÖ ' + response.message);
                    location.reload();
                } else {
                    alert('‚ùå ' + response.message);
                }
            })
            .fail(function() {
                alert('‚ùå C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
            });
    }
}

// H·ªßy ƒë∆°n h√†ng
function cancelBooking(bookingId) {
    if (confirm('B·∫°n mu·ªën H·ªßy ƒë∆°n h√†ng c·ªßa kh√°ch h√†ng?\n\nCh·ªçn OK ƒë·ªÉ "H·ªßy Tour" ho·∫∑c Cancel ƒë·ªÉ "Kh√¥ng H·ªßy".')) {
        $.post('/AdminTour/CancelBooking', {
            bookingId: bookingId,
            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
        })
            .done(function(response) {
                if (response.success) {
                    alert('‚úÖ ' + response.message);
                    location.reload();
                } else {
                    alert('‚ùå ' + response.message);
                }
            })
            .fail(function() {
                alert('‚ùå C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
            });
    }
}

// Li√™n h·ªá kh√°ch h√†ng
function contactCustomer(phoneNumber) {
    if (phoneNumber) {
        const message = `üìû Li√™n h·ªá kh√°ch h√†ng:\n\nS·ªë ƒëi·ªán tho·∫°i: ${phoneNumber}\n\nB·∫°n c√≥ th·ªÉ:\n‚Ä¢ G·ªçi tr·ª±c ti·∫øp\n‚Ä¢ G·ª≠i SMS\n‚Ä¢ Sao ch√©p s·ªë ƒëi·ªán tho·∫°i`;

        if (confirm(message + '\n\nNh·∫•n OK ƒë·ªÉ sao ch√©p s·ªë ƒëi·ªán tho·∫°i v√†o clipboard.')) {
            // Sao ch√©p s·ªë ƒëi·ªán tho·∫°i v√†o clipboard
            navigator.clipboard.writeText(phoneNumber).then(function() {
                alert('‚úÖ ƒê√£ sao ch√©p s·ªë ƒëi·ªán tho·∫°i: ' + phoneNumber);
            }).catch(function() {
                alert('üìû S·ªë ƒëi·ªán tho·∫°i: ' + phoneNumber);
            });
        }
    } else {
        alert('‚ùå Kh√¥ng c√≥ th√¥ng tin s·ªë ƒëi·ªán tho·∫°i!');
    }
}
</script>

<style>
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }

    .tour-details {
        font-size: 0.9rem;
    }

    .payment-info {
        font-size: 0.9rem;
    }

    .booking-date {
        border-top: 1px solid #f0f0f0;
        padding-top: 10px;
    }

    .btn-sm {
        font-size: 0.8rem;
        padding: 0.25rem 0.5rem;
    }

    .gap-2 > * {
        margin-bottom: 0.25rem;
    }
</style>
