@model List<TourDuLich.Models.Booking>
@{
    ViewData["Title"] = "Tour ƒê√£ ƒê·∫∑t";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@Html.AntiForgeryToken()

<div class="container my-5">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2>
                    <i class="bi bi-suitcase-lg text-primary me-2"></i>
                    Tour ƒê√£ ƒê·∫∑t
                </h2>
                <a href="@Url.Action("Index", "Tours")" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle me-2"></i>
                    ƒê·∫∑t tour m·ªõi
                </a>
            </div>
        </div>
    </div>

    @if (Model == null || !Model.Any())
    {
        <!-- Ch∆∞a c√≥ booking -->
        <div class="row">
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted"></i>
                    <h4 class="text-muted mt-3">Ch∆∞a c√≥ tour n√†o ƒë∆∞·ª£c ƒë·∫∑t</h4>
                    <p class="text-muted">H√£y kh√°m ph√° v√† ƒë·∫∑t tour du l·ªãch y√™u th√≠ch c·ªßa b·∫°n!</p>
                    <a href="@Url.Action("Index", "Tours")" class="btn btn-primary btn-lg mt-3">
                        <i class="bi bi-search me-2"></i>
                        T√¨m tour ngay
                    </a>
                </div>
            </div>
        </div>
    }
    else
    {
        <!-- Danh s√°ch booking -->
        <div class="row">
            @foreach (var booking in Model)
            {
                <div class="col-lg-6 mb-4">
                    <div class="card shadow-sm h-100">
                        <!-- Header v·ªõi status -->
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">
                                <i class="bi bi-receipt me-2"></i>
                                ƒê∆°n h√†ng #@booking.BookingId
                            </h6>
                            <span class="badge @GetStatusBadgeClass(booking.Status) fs-6">
                                @GetStatusText(booking.Status)
                            </span>
                        </div>

                        <div class="card-body">
                            <!-- Th√¥ng tin tour -->
                            <div class="tour-info mb-3">
                                <h5 class="card-title text-primary">
                                    <i class="bi bi-geo-alt me-2"></i>
                                    @booking.Tour?.TourName
                                </h5>
                                <div class="tour-details">
                                    <div class="row text-sm">
                                        <div class="col-6">
                                            <strong>üìÖ Kh·ªüi h√†nh:</strong><br>
                                            <span>@booking.DepartureDate.ToString("dd/MM/yyyy")</span>
                                        </div>
                                        <div class="col-6">
                                            <strong>üë• S·ªë kh√°ch:</strong><br>
                                            <span>@(booking.AdultCount + booking.ChildCount + booking.InfantCount + booking.BabyCount) ng∆∞·ªùi</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Th√¥ng tin thanh to√°n -->
                            <div class="payment-info mb-3">
                                <div class="row">
                                    <div class="col-6">
                                        <strong>üí∞ T·ªïng ti·ªÅn:</strong><br>
                                        <span class="text-danger fw-bold">@booking.TotalPrice.ToString("N0") ƒë</span>
                                    </div>
                                    <div class="col-6">
                                        <strong>üí≥ Thanh to√°n:</strong><br>
                                        <span class="badge @GetPaymentStatusBadgeClass(booking.PaymentStatus)">
                                            @GetPaymentStatusText(booking.PaymentStatus)
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <!-- Ng√†y ƒë·∫∑t -->
                            <div class="booking-date">
                                <small class="text-muted">
                                    <i class="bi bi-calendar-check me-1"></i>
                                    ƒê·∫∑t ng√†y: @booking.BookingDate.ToString("dd/MM/yyyy HH:mm")
                                </small>
                            </div>
                        </div>

                        <!-- Footer v·ªõi actions -->
                        <div class="card-footer bg-light">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    @if (booking.PaymentStatus == "Pending")
                                    {
                                        <span class="text-warning small">
                                            <i class="bi bi-clock me-1"></i>
                                            Ch·ªù thanh to√°n
                                        </span>
                                    }
                                    else if (booking.PaymentStatus == "Paid")
                                    {
                                        <span class="text-success small">
                                            <i class="bi bi-check-circle me-1"></i>
                                            ƒê√£ thanh to√°n
                                        </span>
                                    }
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-primary" onclick="viewBookingDetails(@booking.BookingId)">
                                        <i class="bi bi-eye me-1"></i>
                                        Chi ti·∫øt
                                    </button>
                                    @if (booking.Status == "Pending" && booking.PaymentStatus == "Pending")
                                    {
                                        <button class="btn btn-sm btn-outline-danger ms-2" onclick="cancelBooking(@booking.BookingId)">
                                            <i class="bi bi-x-circle me-1"></i>
                                            H·ªßy
                                        </button>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Pagination n·∫øu c·∫ßn -->
        @if (Model.Count > 6)
        {
            <div class="row">
                <div class="col-12">
                    <nav aria-label="Booking pagination">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <span class="page-link">Tr∆∞·ªõc</span>
                            </li>
                            <li class="page-item active">
                                <span class="page-link">1</span>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="#">Sau</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        }
    }
</div>

<!-- Modal Chi Ti·∫øt ƒê∆°n H√†ng -->
<div class="modal fade" id="bookingDetailsModal" tabindex="-1" aria-labelledby="bookingDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="bookingDetailsModalLabel">
                    <i class="bi bi-receipt me-2"></i>Chi Ti·∫øt ƒê∆°n H√†ng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="bookingDetailsContent">
                <div class="text-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="bi bi-x-circle me-1"></i>ƒê√≥ng
                </button>
            </div>
        </div>
    </div>
</div>

@functions {
    string GetStatusBadgeClass(string status)
    {
        return status switch
        {
            "Pending" => "bg-warning text-dark",
            "Confirmed" => "bg-success",
            "Cancelled" => "bg-danger",
            "Completed" => "bg-primary",
            _ => "bg-secondary"
        };
    }

    string GetStatusText(string status)
    {
        return status switch
        {
            "Pending" => "Ch·ªù x√°c nh·∫≠n",
            "Confirmed" => "ƒê√£ x√°c nh·∫≠n",
            "Cancelled" => "ƒê√£ h·ªßy",
            "Completed" => "Ho√†n th√†nh",
            _ => "Kh√¥ng x√°c ƒë·ªãnh"
        };
    }

    string GetPaymentStatusBadgeClass(string paymentStatus)
    {
        return paymentStatus switch
        {
            "Pending" => "bg-warning text-dark",
            "Paid" => "bg-success",
            "Failed" => "bg-danger",
            _ => "bg-secondary"
        };
    }

    string GetPaymentStatusText(string paymentStatus)
    {
        return paymentStatus switch
        {
            "Pending" => "Ch·ªù thanh to√°n",
            "Paid" => "ƒê√£ thanh to√°n",
            "Failed" => "Th·∫•t b·∫°i",
            _ => "Kh√¥ng x√°c ƒë·ªãnh"
        };
    }
}

<style>
    .card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    
    .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
    }
    
    .tour-details {
        font-size: 0.9rem;
    }
    
    .payment-info {
        font-size: 0.9rem;
    }
    
    .booking-date {
        border-top: 1px solid #f0f0f0;
        padding-top: 10px;
    }
</style>

@section Scripts {
<script>
$(document).ready(function() {
    // ƒê·∫£m b·∫£o jQuery ƒë√£ load
    console.log('MyBookings jQuery loaded:', typeof $ !== 'undefined');
    console.log('Bootstrap modal available:', typeof $.fn.modal !== 'undefined');
});

// Xem chi ti·∫øt ƒë∆°n h√†ng
function viewBookingDetails(bookingId) {
    console.log('viewBookingDetails called with bookingId:', bookingId);

    // Ki·ªÉm tra jQuery v√† modal
    if (typeof $ === 'undefined') {
        alert('jQuery ch∆∞a ƒë∆∞·ª£c load!');
        return;
    }

    if (typeof $.fn.modal === 'undefined') {
        alert('Bootstrap modal ch∆∞a ƒë∆∞·ª£c load!');
        return;
    }

    // Hi·ªÉn th·ªã modal
    $('#bookingDetailsModal').modal('show');

    // Load chi ti·∫øt qua AJAX
    console.log('Making AJAX request to /Booking/GetBookingDetails');
    $.get('/Booking/GetBookingDetails', { bookingId: bookingId })
        .done(function(response) {
            console.log('AJAX response received:', response);
            if (response.success) {
                const data = response.data;
                $('#bookingDetailsContent').html(`
                    <div class="row">
                        <!-- Th√¥ng tin ƒë∆°n h√†ng -->
                        <div class="col-12 mb-4">
                            <div class="card border-primary">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-receipt me-2"></i>Th√¥ng Tin ƒê∆°n H√†ng</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>üìã M√£ ƒë∆°n h√†ng:</strong> #${data.bookingId}</p>
                                            <p><strong>üìÖ Ng√†y ƒë·∫∑t:</strong> ${new Date(data.bookingDate).toLocaleDateString('vi-VN')}</p>
                                            <p><strong>üöÄ Ng√†y kh·ªüi h√†nh:</strong> ${data.departureDate}</p>
                                            <p><strong>üìç Kh·ªüi h√†nh t·ª´:</strong> TP. H·ªì Ch√≠ Minh</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>üìä Tr·∫°ng th√°i:</strong> <span class="badge bg-info">${data.status}</span></p>
                                            <p><strong>üí≥ Thanh to√°n:</strong> <span class="badge bg-warning">${data.paymentStatus}</span></p>
                                            <p><strong>üí∞ T·ªïng ti·ªÅn:</strong> <span class="text-danger fw-bold">${parseFloat(data.totalPrice).toLocaleString('vi-VN')} ƒë</span></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Th√¥ng tin tour -->
                        <div class="col-12 mb-4">
                            <div class="card border-success">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-geo-alt me-2"></i>Th√¥ng Tin Tour</h6>
                                </div>
                                <div class="card-body">
                                    <h5 class="text-primary">${data.tourName}</h5>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>üë• Ng∆∞·ªùi l·ªõn:</strong> ${data.adultCount} ng∆∞·ªùi</p>
                                            <p><strong>üë∂ Tr·∫ª em:</strong> ${data.childCount} ng∆∞·ªùi</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>üçº Em b√©:</strong> ${data.infantCount} ng∆∞·ªùi</p>
                                            <p><strong>üë∂ S∆° sinh:</strong> ${data.babyCount} ng∆∞·ªùi</p>
                                        </div>
                                    </div>
                                    ${data.singleRoomCount > 0 ? `<p><strong>üè® Ph√≤ng ƒë∆°n:</strong> ${data.singleRoomCount} ph√≤ng</p>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Th√¥ng tin kh√°ch h√†ng -->
                        <div class="col-12 mb-4">
                            <div class="card border-info">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0"><i class="bi bi-person me-2"></i>Th√¥ng Tin Kh√°ch H√†ng</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>üë§ H·ªç t√™n:</strong> ${data.customerName}</p>
                                            <p><strong>üìß Email:</strong> ${data.customerEmail}</p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>üìû ƒêi·ªán tho·∫°i:</strong> ${data.customerPhone}</p>
                                            <p><strong>üè† ƒê·ªãa ch·ªâ:</strong> ${data.customerAddress || 'Ch∆∞a c·∫≠p nh·∫≠t'}</p>
                                        </div>
                                    </div>
                                    ${data.notes ? `<p><strong>üí¨ Ghi ch√∫:</strong> ${data.notes}</p>` : ''}
                                </div>
                            </div>
                        </div>

                        <!-- Th√¥ng tin thanh to√°n -->
                        <div class="col-12">
                            <div class="card border-warning">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="bi bi-credit-card me-2"></i>Th√¥ng Tin Thanh To√°n</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <p><strong>üí≥ Ph∆∞∆°ng th·ª©c:</strong> ${data.paymentMethod === 'BankTransfer' ? 'Chuy·ªÉn kho·∫£n' : 'Ti·ªÅn m·∫∑t'}</p>
                                            <p><strong>üìä Tr·∫°ng th√°i:</strong> <span class="badge ${data.paymentStatus === 'Paid' ? 'bg-success' : 'bg-warning'}">${data.paymentStatus === 'Paid' ? 'ƒê√£ thanh to√°n' : 'Ch·ªù thanh to√°n'}</span></p>
                                        </div>
                                        <div class="col-md-6">
                                            <p><strong>üí∞ T·ªïng ti·ªÅn:</strong> <span class="text-danger fw-bold fs-5">${parseFloat(data.totalPrice).toLocaleString('vi-VN')} ƒë</span></p>
                                        </div>
                                    </div>
                                    ${data.paymentStatus === 'Pending' && data.paymentMethod === 'BankTransfer' ? `
                                        <div class="alert alert-info mt-3">
                                            <div class="row">
                                                <div class="col-md-8">
                                                    <h6><i class="bi bi-credit-card me-2"></i>Th√¥ng tin chuy·ªÉn kho·∫£n:</h6>
                                                    <p class="mb-1"><strong>üè¶ Ng√¢n h√†ng:</strong><br>MB BANK</p>
                                                    <p class="mb-1"><strong>üí≥ S·ªë t√†i kho·∫£n:</strong><br>0010180808888</p>
                                                    <p class="mb-1"><strong>üë§ Ch·ªß t√†i kho·∫£n:</strong><br>C√îNG TY TNHH ƒê·ª®C TR·ªåNG PQ</p>
                                                    <p class="mb-1"><strong>üí∞ S·ªë ti·ªÅn:</strong><br>${parseFloat(data.totalPrice).toLocaleString('vi-VN')} ƒë</p>
                                                    <p class="mb-0"><strong>üìù N·ªôi dung:</strong><br>Donhang#${data.bookingId} ${data.customerEmail} ${data.customerPhone}</p>
                                                </div>
                                                <div class="col-md-4 text-center">
                                                    <div class="border rounded p-2 bg-white">
                                                        <img src="https://img.vietqr.io/image/970422-0010180808888-compact2.jpg?amount=${data.totalPrice}&addInfo=Donhang%23${data.bookingId}%20${encodeURIComponent(data.customerEmail)}%20${data.customerPhone}&accountName=CONG%20TY%20TNHH%20DUC%20TRONG%20PQ"
                                                             alt="VietQR Code"
                                                             class="img-fluid"
                                                             style="max-width: 150px;">
                                                        <small class="d-block text-muted mt-1">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `);
            } else {
                $('#bookingDetailsContent').html(`
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        ${response.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ƒë∆°n h√†ng!'}
                    </div>
                `);
            }
        })
        .fail(function(xhr, status, error) {
            console.error('AJAX request failed:', xhr, status, error);
            $('#bookingDetailsContent').html(`
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle me-2"></i>
                    C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin. Vui l√≤ng th·ª≠ l·∫°i!<br>
                    <small>Error: ${error}</small>
                </div>
            `);
        });
}

// H·ªßy ƒë∆°n h√†ng
function cancelBooking(bookingId) {
    if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy ƒë∆°n h√†ng n√†y?\n\nL∆∞u √Ω: ƒê∆°n h√†ng ƒë√£ h·ªßy kh√¥ng th·ªÉ kh√¥i ph·ª•c!')) {
        $.post('/Booking/CancelBooking', {
            bookingId: bookingId,
            __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val()
        })
        .done(function(response) {
            if (response.success) {
                alert('‚úÖ ' + response.message);
                location.reload();
            } else {
                alert('‚ùå ' + response.message);
            }
        })
        .fail(function() {
            alert('‚ùå C√≥ l·ªói x·∫£y ra. Vui l√≤ng th·ª≠ l·∫°i!');
        });
    }
}
</script>
}
