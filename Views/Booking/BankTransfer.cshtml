@model TourDuLich.Controllers.PaymentViewModel
@{
    ViewData["Title"] = "Thanh To√°n Chuy·ªÉn Kho·∫£n - " + Model.Tour.TourName;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container my-5">
    <!-- Header v·ªõi ƒë·∫øm ng∆∞·ª£c -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning text-center">
                <h4 class="mb-2">
                    <i class="bi bi-clock text-warning me-2"></i>
                    Th·ªùi gian thanh to√°n c√≤n l·∫°i: <span id="countdown" class="text-danger fw-bold">15:00</span>
                </h4>
                <p class="mb-0">Vui l√≤ng ho√†n t·∫•t thanh to√°n trong th·ªùi gian quy ƒë·ªãnh</p>
            </div>
        </div>
    </div>

    <!-- Th√¥ng tin ƒë∆°n h√†ng -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-receipt me-2"></i>
                        Th√¥ng tin ƒë∆°n h√†ng #@Model.BookingId
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <strong>üéØ Tour:</strong> @Model.Tour.TourName<br>
                            <strong>üìÖ Ng√†y kh·ªüi h√†nh:</strong> @Model.DepartureDate.ToString("dd/MM/yyyy")<br>
                            <strong>üë• S·ªë kh√°ch:</strong> @Model.TotalPassengers ng∆∞·ªùi
                        </div>
                        <div class="col-md-6">
                            <strong>üë§ Kh√°ch h√†ng:</strong> @Model.CustomerName<br>
                            <strong>üìß Email:</strong> @Model.CustomerEmail<br>
                            <strong>üì± ƒêi·ªán tho·∫°i:</strong> @Model.CustomerPhone
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Th√¥ng tin thanh to√°n -->
    <div class="row">
        <div class="col-lg-8">
            <!-- QR Code -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-qr-code me-2"></i>
                        Qu√©t m√£ QR ƒë·ªÉ thanh to√°n
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div id="qrCodeContainer" class="p-4 bg-light rounded">
                        <img id="qrCodeImage" src="" alt="QR Code VietQR" class="img-fluid" style="max-width: 300px;" />
                        <div id="qrCodeLoading" class="text-muted">
                            <div class="spinner-border text-primary me-2" role="status"></div>
                            ƒêang t·∫°o m√£ QR...
                        </div>
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        S·ª≠ d·ª•ng app ng√¢n h√†ng ƒë·ªÉ qu√©t m√£ QR v√† thanh to√°n
                    </p>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Th√¥ng tin chuy·ªÉn kho·∫£n -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-info text-white">
                    <h6 class="mb-0">
                        <i class="bi bi-bank me-2"></i>
                        Th√¥ng tin chuy·ªÉn kho·∫£n
                    </h6>
                </div>
                <div class="card-body">
                    <div class="payment-info">
                        <div class="info-row">
                            <strong>üè¶ Ng√¢n h√†ng:</strong><br>
                            <span class="text-primary">MB BANK</span>
                        </div>
                        <div class="info-row">
                            <strong>üí≥ S·ªë t√†i kho·∫£n:</strong><br>
                            <code class="bg-light p-1 rounded">0010180808888</code>
                        </div>
                        <div class="info-row">
                            <strong>üë§ Ch·ªß t√†i kho·∫£n:</strong><br>
                            <span>C√îNG TY TNHH ƒê·ª®C TR·ªåNG PQ</span>
                        </div>
                        <div class="info-row">
                            <strong>üí∞ S·ªë ti·ªÅn:</strong><br>
                            <span class="text-danger fw-bold fs-5">@Model.TotalAmount.ToString("N0") ƒë</span>
                        </div>
                        <div class="info-row">
                            <strong>üìù N·ªôi dung:</strong><br>
                            <code class="bg-warning bg-opacity-25 p-1 rounded text-dark">Donhang#@(Model.BookingId) @Model.CustomerEmail @Model.CustomerPhone</code>
                        </div>
                        <div class="info-row">
                            <strong>‚è±Ô∏è X·ª≠ l√Ω:</strong><br>
                            <span class="text-success">1-2 gi·ªù l√†m vi·ªác</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- N√∫t h√†nh ƒë·ªông -->
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <div class="d-grid gap-2 d-md-flex justify-content-md-center">
                        <a href="@Url.Action("Checkout", "Booking", new { id = Model.Tour.TourId })" 
                           class="btn btn-outline-secondary btn-lg me-md-2">
                            <i class="bi bi-arrow-left me-2"></i>
                            Quay l·∫°i
                        </a>
                        <button type="button" class="btn btn-success btn-lg" onclick="confirmPayment()">
                            <i class="bi bi-check-circle me-2"></i>
                            ƒê√£ thanh to√°n
                        </button>
                    </div>
                    <p class="text-muted mt-3 mb-0">
                        <small>
                            <i class="bi bi-shield-check me-1"></i>
                            Ch·ªâ nh·∫•n "ƒê√£ thanh to√°n" sau khi ƒë√£ chuy·ªÉn kho·∫£n th√†nh c√¥ng
                        </small>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .payment-info .info-row {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f0f0f0;
    }
    
    .payment-info .info-row:last-child {
        border-bottom: none;
        margin-bottom: 0;
    }
    
    #qrCodeContainer {
        min-height: 320px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px dashed #dee2e6;
    }
    
    #qrCodeImage {
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .countdown-expired {
        background-color: #dc3545 !important;
        color: white !important;
    }
</style>

<script>
    let countdownInterval; // Bi·∫øn global ƒë·ªÉ tr√°nh conflict

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Payment page loaded - Starting countdown and QR generation');

        // Clear any existing intervals
        if (countdownInterval) {
            clearInterval(countdownInterval);
        }

        // ƒê·∫øm ng∆∞·ª£c 15 ph√∫t
        let timeLeft = 15 * 60; // 15 ph√∫t = 900 gi√¢y
        const countdownElement = document.getElementById('countdown');

        function updatePaymentCountdown() {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;

            const displayTime = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            countdownElement.textContent = displayTime;

            console.log(`‚è∞ Payment countdown: ${displayTime} (${timeLeft}s left)`);

            if (timeLeft <= 0) {
                // H·∫øt th·ªùi gian
                clearInterval(countdownInterval);
                document.querySelector('.alert-warning').classList.add('countdown-expired');
                countdownElement.textContent = 'H·∫æT TH·ªúI GIAN';

                setTimeout(() => {
                    alert('ƒê√£ h·∫øt th·ªùi gian thanh to√°n! ƒê∆°n h√†ng s·∫Ω b·ªã h·ªßy.');
                    window.location.href = '@Url.Action("Index", "Tours")';
                }, 1000);

                return;
            }

            timeLeft--;
        }

        // C·∫≠p nh·∫≠t m·ªói gi√¢y
        countdownInterval = setInterval(updatePaymentCountdown, 1000);
        updatePaymentCountdown(); // Ch·∫°y ngay l·∫ßn ƒë·∫ßu

        // T·∫°o QR Code v·ªõi delay nh·ªè
        setTimeout(generateVietQR, 500);
    });

    function generateVietQR() {
        console.log('üîÑ Starting QR Code generation...');

        const qrCodeImage = document.getElementById('qrCodeImage');
        const qrCodeLoading = document.getElementById('qrCodeLoading');

        // Hi·ªÉn th·ªã loading
        qrCodeLoading.style.display = 'block';
        qrCodeImage.style.display = 'none';

        // T·∫°o URL VietQR v·ªõi format ƒë∆°n gi·∫£n h∆°n
        const amount = @(Model.TotalAmount.ToString("0")); // ƒê·∫£m b·∫£o s·ªë thu·∫ßn kh√¥ng c√≥ d·∫•u ph·∫©y
        const bookingId = @Model.BookingId;
        const customerEmail = '@Model.CustomerEmail';
        const customerPhone = '@Model.CustomerPhone';

        // Format: "Donhang#8 tandung@gmail.com 0123456789"
        const transferContent = `Donhang#${bookingId} ${customerEmail} ${customerPhone}`;

        // S·ª≠ d·ª•ng URL tr·ª±c ti·∫øp t·ª´ VietQR (ƒë∆°n gi·∫£n v√† ·ªïn ƒë·ªãnh h∆°n)
        const vietQRUrl = `https://img.vietqr.io/image/970422-0010180808888-compact2.jpg?amount=${amount}&addInfo=${encodeURIComponent(transferContent)}&accountName=${encodeURIComponent('CONG TY TNHH MTV DUC TRONG PQ')}`;

        console.log('üîó QR URL:', vietQRUrl);

        qrCodeImage.onload = function() {
            console.log('‚úÖ QR Code loaded successfully');
            qrCodeLoading.style.display = 'none';
            qrCodeImage.style.display = 'block';
        };

        qrCodeImage.onerror = function() {
            console.log('‚ùå QR Code failed to load, trying alternative...');
            // Th·ª≠ URL kh√°c n·∫øu l·ªói
            const altUrl = `https://api.vietqr.io/image/970422-0010180808888-compact.jpg?amount=${amount}&addInfo=${encodeURIComponent(transferContent)}`;
            console.log('üîÑ Trying alternative URL:', altUrl);

            // T·∫°o image m·ªõi ƒë·ªÉ test
            const testImg = new Image();
            testImg.onload = function() {
                qrCodeImage.src = altUrl;
                qrCodeLoading.style.display = 'none';
                qrCodeImage.style.display = 'block';
            };
            testImg.onerror = function() {
                qrCodeLoading.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> Kh√¥ng th·ªÉ t·∫°o m√£ QR<br><small>Vui l√≤ng chuy·ªÉn kho·∫£n th·ªß c√¥ng</small>';
            };
            testImg.src = altUrl;
        };

        // Set src ƒë·ªÉ b·∫Øt ƒë·∫ßu load
        qrCodeImage.src = vietQRUrl;

        // B·∫Øt ƒë·∫ßu ƒë·∫øm ng∆∞·ª£c ngay l·∫≠p t·ª©c
        startCountdown();
    }
    
    function confirmPayment() {
        if (confirm('B·∫°n ƒë√£ chuy·ªÉn kho·∫£n th√†nh c√¥ng? Ch√∫ng t√¥i s·∫Ω x√°c nh·∫≠n thanh to√°n trong 1-2 gi·ªù l√†m vi·ªác.')) {
            // Chuy·ªÉn ƒë·∫øn trang danh s√°ch tour ƒë√£ ƒë·∫∑t
            window.location.href = '@Url.Action("MyBookings", "Booking")';
        }
    }
</script>
