@model TourDuLich.Controllers.BookingCheckoutViewModel
@{
    ViewData["Title"] = "Thanh to√°n Tour - " + Model.Tour.TourName;
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container my-5">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4">
                <i class="bi bi-credit-card text-primary me-2"></i>
                Thanh To√°n Tour
            </h2>
        </div>
    </div>

    <form asp-controller="Booking" asp-action="Process" method="post">
        <input type="hidden" asp-for="TourId" value="@Model.Tour.TourId" />
        <input type="hidden" asp-for="SelectedDepartureDate" value="@Model.SelectedDepartureDate.ToString("yyyy-MM-dd")" />
        <input type="hidden" asp-for="AdultCount" id="hiddenAdultCount" value="1" />
        <input type="hidden" asp-for="ChildCount" id="hiddenChildCount" value="0" />
        <input type="hidden" asp-for="InfantCount" id="hiddenInfantCount" value="0" />
        <input type="hidden" asp-for="BabyCount" id="hiddenBabyCount" value="0" />
        <input type="hidden" asp-for="SingleRoomCount" id="hiddenSingleRoomCount" value="0" />
        <input type="hidden" asp-for="SingleRoomSupplement" id="hiddenSingleRoomSupplement" value="false" />
        
        <div class="row">
            <!-- C·ªôt tr√°i - Form th√¥ng tin -->
            <div class="col-lg-8">
                
                <!-- 1. TH√îNG TIN TOUR -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-info-circle me-2"></i>Th√¥ng Tin Tour
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                @if (!string.IsNullOrEmpty(Model.Tour.ImageUrl))
                                {
                                    var firstImage = Model.Tour.ImageUrl.Split(';').FirstOrDefault();
                                    <img src="@firstImage" alt="@Model.Tour.TourName" class="img-fluid rounded">
                                }
                            </div>
                            <div class="col-md-8">
                                <h5 class="text-primary">@Model.Tour.TourName</h5>
                                <div class="tour-info-grid">
                                    <div class="info-item">
                                        <strong>M√£ Tour:</strong> <span class="text-primary">@Model.Tour.TourId</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Th·ªùi gian:</strong> @Model.Tour.Duration
                                    </div>
                                    <div class="info-item">
                                        <strong>Gi√°:</strong> <span class="text-danger fw-bold text-nowrap">@Model.Tour.Price.ToString("N0")&nbsp;ƒë</span>
                                    </div>
                                    <div class="info-item">
                                        <strong>Ng√†y kh·ªüi h√†nh:</strong> @(Model.SelectedDepartureDate != DateTime.MinValue ? Model.SelectedDepartureDate.ToString("dd/MM/yyyy") : Model.Tour.DepartureDate.ToString("dd/MM/yyyy"))
                                    </div>
                                    <div class="info-item">
                                        <strong>N∆°i kh·ªüi h√†nh:</strong> @Model.Tour.DepartureFrom
                                    </div>
                                    <div class="info-item">
                                        <strong>S·ªë ch·ªó c√≤n:</strong> <span class="text-success" id="availableSeats">@Model.Tour.GetRealAvailableSeatsForDate(Model.SelectedDepartureDate) ch·ªó</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. L∆ØU √ù -->
                <div class="alert alert-warning mb-4">
                    <h6><i class="bi bi-exclamation-triangle me-2"></i>L∆∞u √Ω:</h6>
                    <p class="mb-0 small">
                        C√°c kho·∫£n ph√≠ ph√°t sinh (n·∫øu c√≥) nh∆∞: ph·ª• thu d√†nh cho kh√°ch n∆∞·ªõc ngo√†i, vi·ªát ki·ªÅu; ph·ª• thu ph√≤ng ƒë∆°n; ph·ª• thu ch√™nh l·ªách gi√° tour‚Ä¶ 
                        Nh√¢n vi√™n <strong>IT TH√çCH DU L·ªäCH</strong> s·∫Ω g·ªçi ƒëi·ªán tho·∫°i t∆∞ v·∫•n cho qu√Ω kh√°ch ngay sau khi c√≥ phi·∫øu x√°c nh·∫≠n booking. (Trong gi·ªù h√†nh ch√≠nh)<br>
                        <strong>Tr∆∞·ªùng h·ª£p qu√Ω kh√°ch kh√¥ng ƒë·ªìng √Ω c√°c kho·∫£n ph√°t sinh, phi·∫øu x√°c nh·∫≠n booking c·ªßa qu√Ω kh√°ch s·∫Ω kh√¥ng c√≥ hi·ªáu l·ª±c.</strong>
                    </p>
                </div>

                <!-- 3. B·∫¢NG GI√Å CHI TI·∫æT -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-table me-2"></i>B·∫£ng Gi√° Tour Chi Ti·∫øt
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-dark">
                                    <tr>
                                        <th>Lo·∫°i gi√°\ƒê·ªô tu·ªïi</th>
                                        <th>Ng∆∞·ªùi l·ªõn<br><small>(Tr√™n 11 tu·ªïi)</small></th>
                                        <th>Tr·∫ª em<br><small>(5 - 11 tu·ªïi)</small></th>
                                        <th>Tr·∫ª nh·ªè<br><small>(2 - 5 tu·ªïi)</small></th>
                                        <th>S∆° sinh<br><small>(&lt; 2 tu·ªïi)</small></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Gi√°</strong></td>
                                        <td class="text-danger fw-bold text-nowrap">@Model.Tour.Price.ToString("N0")&nbsp;ƒë</td>
                                        <td class="text-danger fw-bold text-nowrap">@((Math.Round(Model.Tour.Price * 0.9m / 100000) * 100000).ToString("N0"))&nbsp;ƒë</td>
                                        <td class="text-danger fw-bold text-nowrap">@((Math.Round(Model.Tour.Price * 0.47m / 100000) * 100000).ToString("N0"))&nbsp;ƒë</td>
                                        <td class="text-danger fw-bold text-nowrap">@((Math.Round(Model.Tour.Price * 0.07m / 100000) * 100000).ToString("N0"))&nbsp;ƒë</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Ph·ª• thu N∆∞·ªõc Ngo√†i</strong></td>
                                        <td class="text-warning text-nowrap">590,000&nbsp;ƒë</td>
                                        <td class="text-nowrap">0&nbsp;ƒë</td>
                                        <td class="text-nowrap">0&nbsp;ƒë</td>
                                        <td class="text-nowrap">0&nbsp;ƒë</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Ph·ª• thu Vi·ªát Ki·ªÅu</strong></td>
                                        <td class="text-nowrap">0&nbsp;ƒë</td>
                                        <td class="text-nowrap">0&nbsp;ƒë</td>
                                        <td class="text-nowrap">0&nbsp;ƒë</td>
                                        <td class="text-nowrap">0&nbsp;ƒë</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Ph·ª• thu Ph√≤ng ƒë∆°n</strong></td>
                                        <td colspan="4" class="text-warning text-nowrap">1,300,000&nbsp;ƒë</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 4. TH√îNG TIN LI√äN H·ªÜ -->
                <div class="card mb-4 shadow-sm">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person-lines-fill me-2"></i>Th√¥ng Tin Li√™n H·ªá
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label asp-for="FullName" class="form-label">H·ªç t√™n <span class="text-danger">*</span></label>
                                <input asp-for="FullName" id="FullName" class="form-control" value="@Model.User.FullName" required />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Email" class="form-label">Email <span class="text-danger">*</span></label>
                                <input asp-for="Email" id="Email" type="email" class="form-control" value="@Model.User.Email" required />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Phone" class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                                <input asp-for="Phone" id="Phone" class="form-control" value="@Model.User.Phone" required />
                            </div>
                            <div class="col-md-6 mb-3">
                                <label asp-for="Address" class="form-label">ƒê·ªãa ch·ªâ <span class="text-danger">*</span></label>
                                <input asp-for="Address" id="Address" class="form-control" required />
                            </div>
                            <div class="col-12 mb-3">
                                <label asp-for="Notes" class="form-label">Ghi ch√∫</label>
                                <textarea asp-for="Notes" class="form-control" rows="3" placeholder="Y√™u c·∫ßu ƒë·∫∑c bi·ªát, ghi ch√∫ th√™m..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <!-- C·ªôt ph·∫£i - T√≠nh to√°n gi√° -->
            <div class="col-lg-4">
                <div class="card shadow-sm sticky-top">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">
                            <i class="bi bi-calculator me-2"></i>T√≠nh To√°n Gi√°
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- S·ªê L∆Ø·ª¢NG NG∆Ø·ªúI -->
                        <div class="passenger-counts mb-4">
                            <div class="count-item mb-3">
                                <label class="form-label">Ng∆∞·ªùi l·ªõn:</label>
                                <input asp-for="AdultCount" type="number" min="1" value="1" class="form-control passenger-input" data-price="@Model.Tour.Price" />
                            </div>
                            <div class="count-item mb-3">
                                <label class="form-label">Tr·∫ª em (5-11 tu·ªïi):</label>
                                <input asp-for="ChildCount" type="number" min="0" value="0" class="form-control passenger-input" data-price="@((Math.Round(Model.Tour.Price * 0.9m / 100000) * 100000))" />
                            </div>
                            <div class="count-item mb-3">
                                <label class="form-label">Tr·∫ª nh·ªè (2-5 tu·ªïi):</label>
                                <input asp-for="InfantCount" type="number" min="0" value="0" class="form-control passenger-input" data-price="@((Math.Round(Model.Tour.Price * 0.47m / 100000) * 100000))" />
                            </div>
                            <div class="count-item mb-3">
                                <label class="form-label">S∆° sinh (nh·ªè h∆°n 2 tu·ªïi):</label>
                                <input asp-for="BabyCount" type="number" min="0" value="0" class="form-control passenger-input" data-price="@((Math.Round(Model.Tour.Price * 0.07m / 100000) * 100000))" />
                            </div>
                        </div>

                        <!-- PH·ª§ THU PH√íNG ƒê∆†N -->
                        <div class="room-supplement mb-4">
                            <h6>Ph·ª• thu ph√≤ng ƒë∆°n:</h6>
                            <div class="form-check">
                                <input name="SingleRoomSupplement" class="form-check-input" type="radio" value="false" checked id="singleRoomNo" />
                                <label class="form-check-label" for="singleRoomNo">Kh√¥ng</label>
                            </div>
                            <div class="form-check">
                                <input name="SingleRoomSupplement" class="form-check-input" type="radio" value="true" id="singleRoomYes" />
                                <label class="form-check-label" for="singleRoomYes">C√≥</label>
                            </div>
                            <div class="mt-2">
                                <label class="form-label">S·ªë l∆∞·ª£ng ph√≤ng ƒë∆°n:</label>
                                <input asp-for="SingleRoomCount" type="number" min="0" value="0" class="form-control" disabled />
                            </div>
                        </div>

                        <!-- T·ªîNG GI√Å TR·ªä -->
                        <div class="total-price mb-4">
                            <h4 class="text-center">
                                <span class="badge bg-danger fs-5 p-3 w-100">
                                    T·ªïng gi√° tr·ªã: <span id="totalAmount">@Model.Tour.Price.ToString("N0")</span>&nbsp;ƒë
                                </span>
                            </h4>
                        </div>

                        <!-- PH∆Ø∆†NG TH·ª®C THANH TO√ÅN -->
                        <div class="payment-methods mb-4">
                            <h6 class="mb-3">
                                <i class="bi bi-credit-card text-primary me-2"></i>Ph∆∞∆°ng th·ª©c thanh to√°n:
                            </h6>

                            <!-- Chuy·ªÉn kho·∫£n ng√¢n h√†ng -->
                            <div class="form-check mb-3">
                                <input asp-for="PaymentMethod" class="form-check-input" type="radio" value="BankTransfer" id="bankTransfer" checked />
                                <label class="form-check-label" for="bankTransfer">
                                    <i class="bi bi-bank text-primary me-2"></i>
                                    <strong>Thanh to√°n chuy·ªÉn kho·∫£n ng√¢n h√†ng</strong>
                                    <div class="text-muted small">Chuy·ªÉn kho·∫£n qua ATM, Internet Banking ho·∫∑c Mobile Banking</div>
                                </label>
                            </div>

                            <!-- Thanh to√°n ti·ªÅn ƒëi·ªán t·ª≠ -->
                            <div class="form-check">
                                <input asp-for="PaymentMethod" class="form-check-input" type="radio" value="Crypto" id="crypto" />
                                <label class="form-check-label" for="crypto">
                                    <i class="bi bi-currency-bitcoin text-warning me-2"></i>
                                    <strong>Thanh to√°n ti·ªÅn ƒëi·ªán t·ª≠</strong>
                                    <div class="text-muted small">H·ªó tr·ª£ USDT (TRC20), Bitcoin (BTC) - S·∫Ω c·∫≠p nh·∫≠t sau</div>
                                </label>
                            </div>
                        </div>

                        <!-- N√öT THANH TO√ÅN -->
                        <div class="text-center">
                            <p class="small text-muted mb-3">
                                Khi nh·∫•n 'Thanh To√°n', b·∫°n ƒë·ªìng √Ω v·ªõi ƒêi·ªÅu kho·∫£n & Ch√≠nh s√°ch ƒë√£ n√™u ·ªü tr√™n.
                            </p>
                            <button type="submit" class="btn btn-success btn-lg w-100" id="paymentButton" onclick="handlePaymentSubmit(event)">
                                <i class="bi bi-credit-card me-2"></i>
                                <span id="paymentButtonText">Thanh To√°n</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

<style>
    .tour-info-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.5rem;
    }
    
    .info-item {
        padding: 0.25rem 0;
    }
    
    .passenger-input {
        max-width: 100px;
        display: inline-block;
    }
    
    .count-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .sticky-top {
        top: 20px;
    }

    /* Smooth scroll behavior */
    html {
        scroll-behavior: smooth;
    }

    /* Payment Methods Styling */
    .payment-option {
        border: 2px solid #e9ecef;
        border-radius: 10px;
        transition: all 0.3s ease;
    }

    .payment-option:hover {
        border-color: #007bff;
        box-shadow: 0 2px 8px rgba(0,123,255,0.1);
    }

    .payment-card {
        padding: 15px;
        margin: 0;
        cursor: pointer;
    }

    .payment-card .form-check-input:checked ~ .form-check-label {
        color: #007bff;
        font-weight: 600;
    }

    .payment-option:has(.form-check-input:checked) {
        border-color: #007bff;
        background-color: #f8f9ff;
    }

    .payment-details {
        padding: 0 15px 15px 15px;
        animation: slideDown 0.3s ease;
    }

    keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
        }
        to {
            opacity: 1;
            max-height: 300px;
        }
    }

    .payment-details code {
        background-color: #f8f9fa;
        padding: 5px 8px;
        border-radius: 4px;
        font-size: 0.9rem;
        word-break: break-all;
    }

    /* QR Code Styling */
    #qrCodeContainer {
        border: 2px dashed #dee2e6;
        min-height: 280px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
    }

    #qrCodeContainer:hover {
        border-color: #007bff;
        background-color: #f8f9ff;
    }

    #qrCodeImage {
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        transition: transform 0.2s ease;
    }

    #qrCodeImage:hover {
        transform: scale(1.05);
    }

    #qrCodeLoading {
        font-size: 1.1rem;
        color: #6c757d;
    }

    #transferAmount {
        font-size: 1.2rem;
    }

    #transferContent {
        font-family: 'Courier New', monospace;
        font-size: 0.9rem;
        background-color: #e3f2fd;
        padding: 2px 6px;
        border-radius: 4px;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const passengerInputs = document.querySelectorAll('.passenger-input');
        const singleRoomRadios = document.querySelectorAll('input[name="SingleRoomSupplement"]');
        const singleRoomCount = document.getElementById('SingleRoomCount');
        const totalAmountSpan = document.getElementById('totalAmount');

        function calculateTotal() {
            let total = 0;
            let totalGuests = 0;

            // T√≠nh ti·ªÅn h√†nh kh√°ch v√† t·ªïng s·ªë kh√°ch
            passengerInputs.forEach(input => {
                const count = parseInt(input.value) || 0;
                const price = parseFloat(input.dataset.price) || 0;
                total += count * price;
                totalGuests += count;
            });

            // T√≠nh ph·ª• thu ph√≤ng ƒë∆°n
            const hasSingleRoom = document.querySelector('input[name="SingleRoomSupplement"]:checked').value === 'true';
            if (hasSingleRoom) {
                const roomCount = parseInt(singleRoomCount.value) || 0;
                total += roomCount * 1300000; // 1.3 tri·ªáu/ph√≤ng
            }

            // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
            totalAmountSpan.innerHTML = total.toLocaleString('vi-VN');

            // C·∫≠p nh·∫≠t s·ªë ch·ªó c√≤n l·∫°i
            const maxSeats = @Model.Tour.GetRealAvailableSeatsForDate(Model.SelectedDepartureDate);
            const remainingSeats = Math.max(0, maxSeats - totalGuests);
            const availableSeatsElement = document.getElementById('availableSeats');
            if (availableSeatsElement) {
                availableSeatsElement.textContent = remainingSeats + ' ch·ªó';
            }

            // C·∫≠p nh·∫≠t hidden fields v·ªõi ƒë√∫ng t√™n
            document.getElementById('hiddenAdultCount').value = document.getElementById('AdultCount').value || 0;
            document.getElementById('hiddenChildCount').value = document.getElementById('ChildCount').value || 0;
            document.getElementById('hiddenInfantCount').value = document.getElementById('InfantCount').value || 0;
            document.getElementById('hiddenBabyCount').value = document.getElementById('BabyCount').value || 0;
            document.getElementById('hiddenSingleRoomCount').value = document.getElementById('SingleRoomCount').value || 0;

            // üîÑ C·∫≠p nh·∫≠t QR Code n·∫øu ƒëang ch·ªçn chuy·ªÉn kho·∫£n
            const selectedMethod = document.querySelector('input[name="PaymentMethod"]:checked');
            if (selectedMethod && selectedMethod.value === 'BankTransfer') {
                // Delay m·ªôt ch√∫t ƒë·ªÉ ƒë·∫£m b·∫£o DOM ƒë√£ c·∫≠p nh·∫≠t
                setTimeout(() => {
                    generateVietQR();
                }, 100);
            }
        }

        // Event listeners
        passengerInputs.forEach(input => {
            input.addEventListener('input', calculateTotal);
        });

        singleRoomRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                singleRoomCount.disabled = this.value === 'false';
                if (this.value === 'false') {
                    singleRoomCount.value = 0;
                }
                calculateTotal();
            });
        });

        singleRoomCount.addEventListener('input', calculateTotal);

        // ƒê∆°n gi·∫£n h√≥a - ch·ªâ c·∫ßn c·∫≠p nh·∫≠t text n√∫t
        const paymentMethods = document.querySelectorAll('input[name="PaymentMethod"]');
        const paymentButtonText = document.getElementById('paymentButtonText');

        function updatePaymentMethod() {
            const selectedMethod = document.querySelector('input[name="PaymentMethod"]:checked').value;

            if (selectedMethod === 'BankTransfer') {
                paymentButtonText.textContent = 'Thanh To√°n Chuy·ªÉn Kho·∫£n';
            } else if (selectedMethod === 'Crypto') {
                paymentButtonText.textContent = 'Thanh To√°n Crypto';
            }
        }

        // Event listeners cho payment methods
        paymentMethods.forEach(radio => {
            radio.addEventListener('change', updatePaymentMethod);
        });

        // Initial setup
        updatePaymentMethod();
    });

    // Validation ƒë∆°n gi·∫£n ch·ªâ ki·ªÉm tra s·ªë ng∆∞·ªùi v√† ph∆∞∆°ng th·ª©c thanh to√°n
    function handlePaymentSubmit(event) {
        // Ki·ªÉm tra s·ªë ng∆∞·ªùi l·ªõn - s·ª≠ d·ª•ng ƒë√∫ng t√™n field
        const adults = parseInt(document.getElementById('AdultCount').value) || 0;
        if (adults < 1) {
            alert('Ph·∫£i c√≥ √≠t nh·∫•t 1 ng∆∞·ªùi l·ªõn!');
            event.preventDefault();
            return false;
        }

        // Ki·ªÉm tra ph∆∞∆°ng th·ª©c thanh to√°n
        const paymentMethod = document.querySelector('input[name="PaymentMethod"]:checked');
        if (!paymentMethod) {
            alert('Vui l√≤ng ch·ªçn ph∆∞∆°ng th·ª©c thanh to√°n!');
            event.preventDefault();
            return false;
        }

        // ƒê·ªÉ HTML5 validation x·ª≠ l√Ω c√°c field required kh√°c
        return true;
    }
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}
